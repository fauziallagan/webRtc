(()=>{mdc.ripple.MDCRipple.attachTo(document.querySelector(".mdc-button"));const e={iceServers:[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}],iceCandidatePoolSize:10};let t=null,o=null,n=null,c=null,a=null;function r(){t.addEventListener("icegatheringstatechange",(()=>{console.log(`ICE gathering state changed: ${t.iceGatheringState}`)})),t.addEventListener("connectionstatechange",(()=>{console.log(`Connection state change: ${t.connectionState}`)})),t.addEventListener("signalingstatechange",(()=>{console.log(`Signaling state change: ${t.signalingState}`)})),t.addEventListener("iceconnectionstatechange ",(()=>{console.log(`ICE connection state change: ${t.iceConnectionState}`)}))}document.querySelector("#cameraBtn").addEventListener("click",(async function(e){const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});document.querySelector("#localVideo").srcObject=t,o=t,n=new MediaStream,document.querySelector("#remoteVideo").srcObject=n,console.log("Stream:",document.querySelector("#localVideo").srcObject),document.querySelector("#cameraBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!1,document.querySelector("#createBtn").disabled=!1,document.querySelector("#hangupBtn").disabled=!1})),document.querySelector("#hangupBtn").addEventListener("click",(async function(e){if(document.querySelector("#localVideo").srcObject.getTracks().forEach((e=>{e.stop()})),n&&n.getTracks().forEach((e=>e.stop())),t&&t.close(),document.querySelector("#localVideo").srcObject=null,document.querySelector("#remoteVideo").srcObject=null,document.querySelector("#cameraBtn").disabled=!1,document.querySelector("#joinBtn").disabled=!0,document.querySelector("#createBtn").disabled=!0,document.querySelector("#hangupBtn").disabled=!0,document.querySelector("#currentRoom").innerText="",a){const e=firebase.firestore().collection("webrtc").doc(a);(await e.collection("calleeCandidates").get()).forEach((async e=>{await e.ref.delete()})),(await e.collection("callerCandidates").get()).forEach((async e=>{await e.ref.delete()})),await e.delete()}document.location.reload(!0)})),document.querySelector("#createBtn").addEventListener("click",(async function(){document.querySelector("#createBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!0;const c=firebase.firestore(),d=await c.collection("webrtc").doc();console.log("Create PeerConnection with configuration: ",e),t=new RTCPeerConnection(e),r(),o.getTracks().forEach((e=>{t.addTrack(e,o)}));const i=d.collection("callerCandidates");t.addEventListener("icecandidate",(e=>{e.candidate?(console.log("Got candidate: ",e.candidate),i.add(e.candidate.toJSON())):console.log("Got final candidate!")}));const l=await t.createOffer();await t.setLocalDescription(l),console.log("Created offer:",l);const s={offer:{type:l.type,sdp:l.sdp}};await d.set(s),a=d.id,console.log(`New room created with SDP offer. Room ID: ${d.id}`),document.querySelector("#currentRoom").innerText=`Current room is ${d.id} - You are the caller!`,t.addEventListener("track",(e=>{console.log("Got remote track:",e.streams[0]),e.streams[0].getTracks().forEach((e=>{console.log("Add a track to the remoteStream:",e),n.addTrack(e)}))})),d.onSnapshot((async e=>{const o=e.data();if(!t.currentRemoteDescription&&o&&o.answer){console.log("Got remote description: ",o.answer);const e=new RTCSessionDescription(o.answer);await t.setRemoteDescription(e)}})),d.collection("calleeCandidates").onSnapshot((e=>{e.docChanges().forEach((async e=>{if("added"===e.type){let o=e.doc.data();console.log(`Got new remote ICE candidate: ${JSON.stringify(o)}`),await t.addIceCandidate(new RTCIceCandidate(o))}}))}))})),document.querySelector("#joinBtn").addEventListener("click",(function(){document.querySelector("#createBtn").disabled=!0,document.querySelector("#joinBtn").disabled=!0,document.querySelector("#confirmJoinBtn").addEventListener("click",(async()=>{a=document.querySelector("#room-id").value,console.log("Join room: ",a),document.querySelector("#currentRoom").innerText=`Current room is ${a} - You are the callee!`,await async function(c){const a=firebase.firestore().collection("webrtc").doc(`${c}`),d=await a.get();if(console.log("Got room:",d.exists),d.exists){console.log("Create PeerConnection with configuration: ",e),t=new RTCPeerConnection(e),r(),o.getTracks().forEach((e=>{t.addTrack(e,o)}));const c=a.collection("calleeCandidates");t.addEventListener("icecandidate",(e=>{e.candidate?(console.log("Got candidate: ",e.candidate),c.add(e.candidate.toJSON())):console.log("Got final candidate!")})),t.addEventListener("track",(e=>{console.log("Got remote track:",e.streams[0]),e.streams[0].getTracks().forEach((e=>{console.log("Add a track to the remoteStream:",e),n.addTrack(e)}))}));const i=d.data().offer;console.log("Got offer:",i),await t.setRemoteDescription(new RTCSessionDescription(i));const l=await t.createAnswer();console.log("Created answer:",l),await t.setLocalDescription(l);const s={answer:{type:l.type,sdp:l.sdp}};await a.update(s),a.collection("callerCandidates").onSnapshot((e=>{e.docChanges().forEach((async e=>{if("added"===e.type){let o=e.doc.data();console.log(`Got new remote ICE candidate: ${JSON.stringify(o)}`),await t.addIceCandidate(new RTCIceCandidate(o))}}))}))}}(a)}),{once:!0}),c.open()})),c=new mdc.dialog.MDCDialog(document.querySelector("#room-dialog"))})();